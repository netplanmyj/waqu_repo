# 水質報告アプリ デプロイメント手順書

この手順書では、水質報告アプリを個人利用するために必要なGoogle Apps Script（GAS）のセットアップ方法を説明します。

## 🎯 概要

水質報告アプリは以下の構成で動作します：

```
[スマートフォンアプリ] → [個人のGoogle Apps Script] → [Gmailでメール送信]
```

各利用者は、自分専用のGoogle Apps Scriptを作成・デプロイし、そのURLをアプリに設定する必要があります。

## 📋 事前準備

### 必要なもの
- Googleアカウント
- PCまたはスマートフォンのWebブラウザ
- 水質報告アプリ（Android）

### 所要時間
- 初回設定：約10-15分
- アプリ設定：約5分

## 🚀 Google Apps Script セットアップ手順

### ステップ1: Google Apps Script プロジェクトの作成

1. **Google Apps Scriptにアクセス**
   - ブラウザで https://script.google.com/ を開く
   - Googleアカウントでログイン

2. **新しいプロジェクトを作成**
   - 「新しいプロジェクト」ボタンをクリック
   - プロジェクト名を「水質報告システム」などに変更（左上の「無題のプロジェクト」をクリック）

### ステップ2: コードの設定

1. **デフォルトコードを削除**
   - エディタに表示されている`myFunction() { }`のコードをすべて削除

2. **水質報告用コードをコピー**
   - [gas/Code.gs](./gas/Code.gs) ファイルの内容をすべてコピー
   - Google Apps Scriptエディタに貼り付け

3. **保存**
   - `Ctrl+S`（Windows）または`Cmd+S`（Mac）で保存
   - または「保存」ボタンをクリック

### ステップ3: テスト実行（推奨）

1. **テスト関数の編集**
   - エディタで`testEmailSend`関数を探す
   - `recipientEmail: 'test@example.com'`の部分を自分のメールアドレスに変更

2. **テスト実行**
   - 関数選択ドロップダウンから`testEmailSend`を選択
   - 「実行」ボタンをクリック
   - 初回実行時は権限の許可が必要（後述）

3. **メール受信確認**
   - 指定したメールアドレスにテストメールが届くことを確認

### ステップ4: 権限の許可

初回実行時に権限の許可が必要です：

1. **承認画面が表示された場合**
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「水質報告システム（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

2. **必要な権限**
   - Gmailの送信権限
   - スクリプトの実行権限

### ステップ5: WebアプリとしてデプロイA

1. **デプロイメニューを開く**
   - 画面右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」を選択

2. **設定を行う**
   - 種類：「ウェブアプリ」を選択
   - 説明：「水質報告システム」など任意の説明を入力
   - 実行ユーザー：「自分」を選択
   - アクセスできるユーザー：「全員」を選択

3. **デプロイ実行**
   - 「デプロイ」ボタンをクリック
   - 再度権限の許可が求められる場合があります

4. **WebアプリURLの取得**
   - デプロイ完了後、「ウェブアプリ」のURLが表示されます
   - このURLをコピーして保存してください
   - 例：`https://script.google.com/macros/s/AKfycbx.../exec`

## 📱 アプリ設定手順

### ステップ1: アプリの設定画面を開く

1. 水質報告アプリを起動
2. 右上の歯車アイコン（設定）をタップ

### ステップ2: GAS URLの設定

1. **GAS WebアプリURL**
   - 前のステップで取得したURLを入力
   - 正しい形式：`https://script.google.com/macros/s/.../exec`

2. **地点番号**
   - 測定地点の識別番号を入力（例：01, 02）

3. **送信先メールアドレス**
   - 水質報告を受信したいメールアドレスを入力

4. **テスト用送信先メールアドレス**
   - テスト送信用のメールアドレスを入力（通常は自分のアドレス）

### ステップ3: テスト送信

1. **デバッグモードを有効化**
   - 設定画面で「デバッグモード」をONにする

2. **テスト送信の実行**
   - メイン画面に戻る
   - 時刻と塩素濃度を入力
   - 「今日の報告を送信」ボタンをタップ

3. **送信結果の確認**
   - 「メールが正常に送信されました（テストモード: xxx@xxx.com）」と表示されれば成功
   - テスト用メールアドレスにメールが届くことを確認

4. **本番モードへの切り替え**
   - テストが成功したら、設定画面で「デバッグモード」をOFFにする

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. 「GAS WebアプリURLが設定されていません」エラー
**原因**: URLが正しく設定されていない
**解決**: 
- URLの形式を確認（`https://script.google.com/macros/s/.../exec`）
- コピー時に余分なスペースが入っていないか確認

#### 2. 「通信エラーが発生しました」エラー
**原因**: ネットワーク接続またはGAS側の問題
**解決**:
- インターネット接続を確認
- Google Apps Scriptが正しくデプロイされているか確認
- GAS エディタでテスト関数を実行して動作確認

#### 3. 「サーバーエラーが発生しました」エラー
**原因**: GASスクリプトの実行エラー
**解決**:
- Google Apps Script エディタで実行ログを確認
- コードが正しくコピーされているか確認
- 権限が正しく許可されているか確認

#### 4. メールが届かない
**原因**: メールアドレスの設定ミスまたはGmailの制限
**解決**:
- 送信先メールアドレスを確認
- 迷惑メールフォルダを確認
- Gmailの送信制限（1日100通）を確認

#### 5. 「権限エラー」が発生
**原因**: GASの実行権限が不足
**解決**:
- Google Apps Scriptで再度権限の許可を行う
- 「実行ユーザー」が「自分」、「アクセスできるユーザー」が「全員」に設定されているか確認

## 📊 運用時の注意事項

### Gmailの送信制限
- **制限**: 1日あたり100通まで
- **対策**: 複数人で使用する場合は、それぞれ個別のGASを作成

### セキュリティ
- **WebアプリURL**: 他人と共有しないでください
- **メールアドレス**: 正しい送信先を設定してください
- **定期確認**: デプロイしたGASが正常に動作しているか定期的に確認

### バックアップ
- **GASコード**: 重要な設定変更を行った場合は、コードをバックアップ
- **WebアプリURL**: URLを安全な場所に保存

## 🔄 更新・メンテナンス

### アプリの更新時
新しいバージョンのアプリがリリースされた場合：
1. GASコードの更新が必要かREADMEで確認
2. 必要に応じてGASコードを更新
3. 新しい機能が追加された場合は設定を確認

### GASコードの更新方法
1. Google Apps Script エディタを開く
2. 新しいコードで既存のコードを置き換え
3. 保存
4. 必要に応じて再デプロイ

## 📞 サポート

### 問題が解決しない場合
1. この手順書を最初から再確認
2. テスト送信で問題の切り分けを行う
3. Google Apps Scriptの実行ログを確認

### その他の注意事項
- このシステムは個人利用を前提としています
- 業務利用の場合は、組織のIT管理者に相談してください
- 大量送信が必要な場合は、Gmail API などの利用を検討してください

---

**🎉 セットアップ完了おめでとうございます！**

これで水質報告アプリが使用できるようになりました。定期的な水質報告に活用してください。