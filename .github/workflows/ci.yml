name: CI

# プッシュとプルリクエスト時にテストを実行
on:
  push:
    branches: [ main ]
    # 一時的に他のブランチでのCIを無効化
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 5分でタイムアウト

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    # Firebase設定ファイルをGitHub Secretsから注入
    - name: Setup Firebase config files
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        IOS_GOOGLE_SERVICE_INFO_PLIST: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST }}
      run: |
        # Android用google-services.json
        if [ -n "$GOOGLE_SERVICES_JSON" ]; then
          echo "$GOOGLE_SERVICES_JSON" | base64 -d > android/app/google-services.json
          echo "✅ Android google-services.json created"
        else
          echo "⚠️  GOOGLE_SERVICES_JSON secret not found - skipping Android config"
        fi
        
        # iOS用GoogleService-Info.plist
        if [ -n "$IOS_GOOGLE_SERVICE_INFO_PLIST" ]; then
          echo "$IOS_GOOGLE_SERVICE_INFO_PLIST" | base64 -d > ios/Runner/GoogleService-Info.plist
          echo "✅ iOS GoogleService-Info.plist created"
        else
          echo "⚠️  IOS_GOOGLE_SERVICE_INFO_PLIST secret not found - skipping iOS config"
        fi

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test
      env:
        FLUTTER_TEST: true  # テスト実行中であることを示すフラグ